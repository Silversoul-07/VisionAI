<!DOCTYPE html>
<html>
<head>
    <title>AI Surveillance Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            background: #000;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
        }

        .tab {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .camera-grid {
            display: grid;
            gap: 2px;
            height: calc(100vh - 100px);
        }

        .grid-quadra { grid-template-columns: repeat(2, 1fr); }
        .grid-dual { grid-template-columns: repeat(2, 1fr); }
        .grid-single { grid-template-columns: 1fr; }

        .camera-container {
            position: relative;
            background: black;
            overflow: hidden;
        }

        .camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="tabs">
        <button class="tab active" data-view="quadra">Quadra</button>
        <button class="tab" data-view="dual">Dual</button>
        <button class="tab" data-view="single">Single</button>
    </div>

    <div class="camera-grid grid-quadra" id="camera-grid"></div>

    <script>
        const cameras = [
            { id: 'camera1', name: 'Front Entrance' },
            { id: 'camera2', name: 'Parking Lot' },
            { id: 'camera3', name: 'Loading Dock' },
            { id: 'camera4', name: 'Rear Exit' }
        ];

        const connections = {};
        const cameraStates = {};
        let currentView = 'quadra';
        let currentCameraIndex = 0;
        let startTime;

        function initializeDashboard() {
            const grid = document.getElementById('camera-grid');
            
            cameras.forEach(camera => {
                const container = document.createElement('div');
                container.className = 'camera-container';
                container.id = `container-${camera.id}`;
                
                const feed = document.createElement('img');
                feed.className = 'camera-feed';
                feed.id = `feed-${camera.id}`;
                
                const info = document.createElement('div');
                info.className = 'info-overlay';
                info.id = `info-${camera.id}`;
                
                container.appendChild(feed);
                container.appendChild(info);
                grid.appendChild(container);
                
                initializeWebSocket(camera);
                
                cameraStates[camera.id] = {
                    lastUpdate: Date.now(),
                    detections: 0,
                    latency: 0,
                    active: false
                };
            });

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    setView(tab.dataset.view);
                });
            });

            if (currentView === 'single') {
                addCameraControls();
            }

            updateSummaryPanel();
            setInterval(updateSummaryPanel, 1000);
            startTime = performance.now();
        }

        function initializeWebSocket(camera) {
            const ws = new WebSocket(`ws://localhost:8000/ws/video_feed/${camera.id}`);
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                const feed = document.getElementById(`feed-${camera.id}`);
                const info = document.getElementById(`info-${camera.id}`);
                const latency = performance.now() - startTime;
                
                feed.src = data.result_image;
                info.innerHTML = `
                    ${camera.name}<br>
                    Detections: ${data.detections.length}<br>
                    Latency: ${Math.round(latency)}ms
                `;
                
                cameraStates[camera.id] = {
                    lastUpdate: Date.now(),
                    detections: data.detections.length,
                    latency: Math.round(latency),
                    active: true
                };
            };
            
            ws.onerror = function(error) {
                console.error(`WebSocket error for ${camera.id}:`, error);
                cameraStates[camera.id].active = false;
            };
            
            connections[camera.id] = ws;
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });

            const grid = document.getElementById('camera-grid');
            grid.className = `camera-grid grid-${view}`;

            document.querySelectorAll('.camera-container').forEach((container, index) => {
                if (view === 'single') {
                    container.style.display = index === currentCameraIndex ? 'block' : 'none';
                } else if (view === 'dual') {
                    container.style.display = index < 2 ? 'block' : 'none';
                } else {
                    container.style.display = 'block';
                }
            });

            const existingControls = document.querySelector('.camera-controls');
            if (existingControls) {
                existingControls.remove();
            }

            if (view === 'single') {
                addCameraControls();
            }
        }

        function addCameraControls() {
            const controls = document.createElement('div');
            controls.className = 'camera-controls';
            
            controls.innerHTML = `
                <button class="control-button" onclick="switchCamera(-1)">Previous</button>
                <button class="control-button" onclick="switchCamera(1)">Next</button>
            `;
            
            document.getElementById('camera-grid').appendChild(controls);
        }

        function switchCamera(direction) {
            currentCameraIndex = (currentCameraIndex + direction + cameras.length) % cameras.length;
            setView('single');
        }

        function updateSummaryPanel() {
            const panel = document.getElementById('summary-panel');
            let summary = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">';
            
            cameras.forEach(camera => {
                const state = cameraStates[camera.id];
                const timeSinceUpdate = Date.now() - state.lastUpdate;
                const isActive = state.active && timeSinceUpdate < 5000;
                
                summary += `
                    <div>
                        <span class="status-indicator ${isActive ? 'status-active' : 'status-inactive'}"></span>
                        <strong>${camera.name}</strong><br>
                        Status: ${isActive ? 'Active' : 'Inactive'}<br>
                        Detections: ${state.detections}<br>
                        Latency: ${state.latency}ms
                    </div>
                `;
            });
            
            summary += '</div>';
            panel.innerHTML = summary;
        }

        initializeDashboard();
    </script>
</body>
</html>